name: Manual Deploy

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref (branch or tag) to deploy"
        required: false
        default: master
      host:
        description: "Optional matrix host name (deploy all if empty)"
        required: false
        default: ""
      component:
        description: "Which part to deploy (auto, backend, frontend, both)"
        required: false
        default: auto

jobs:
  targets:
    name: Prepare Deploy Targets
    runs-on: ubuntu-latest
    outputs:
      matrix_b64: ${{ steps.collect.outputs.matrix_b64 }}
    steps:
      - id: collect
        run: |
          raw='${{ secrets.DEPLOY_TARGETS }}'
          if [ -z "$raw" ]; then
            raw='[{"name":"_none","skip":true}]'
          fi
          set +e
          matrix=$(python3 -c "import json,sys; data=json.loads(sys.stdin.read()); data=[data] if not isinstance(data, list) else data; print(json.dumps(data))" <<<"$raw" 2>&1)
          exit_code=$?
          set -e
          if [ $exit_code -ne 0 ]; then
            echo "Error parsing JSON: $matrix"
            matrix='[{"name":"_none","skip":true}]'
          fi
          # Base64 encode for reliable single-line output
          matrix_b64=$(echo -n "$matrix" | base64 -w 0)
          echo "matrix_b64=$matrix_b64" >> "$GITHUB_OUTPUT"
          echo "Matrix encoded (length: ${#matrix_b64})"
  
  decode-matrix:
    name: Decode Matrix
    runs-on: ubuntu-latest
    needs: targets
    outputs:
      matrix: ${{ steps.decode.outputs.matrix }}
    steps:
      - id: decode
        run: |
          matrix_b64='${{ needs.targets.outputs.matrix_b64 }}'
          if [ -z "$matrix_b64" ]; then
            matrix='[{"name":"_none","skip":true}]'
          else
            matrix=$(echo -n "$matrix_b64" | base64 -d)
          fi
          # Use multiline format for the decoded JSON
          delimiter="MATRIX_$(openssl rand -hex 16)"
          {
            echo "matrix<<${delimiter}"
            echo "$matrix"
            echo "${delimiter}"
          } >> "$GITHUB_OUTPUT"
            echo "Matrix decoded and written"

  detect-scope:
    name: Detect Deploy Scope
    runs-on: ubuntu-latest
    outputs:
      deploy_backend: ${{ steps.set.outputs.deploy_backend }}
      deploy_frontend: ${{ steps.set.outputs.deploy_frontend }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref }}
          fetch-depth: 0

      - name: Determine default branch
        id: default-branch
        run: |
          default_branch=$(git remote show origin | sed -n 's/  HEAD branch: //p')
          default_branch=${default_branch:-master}
          echo "value=$default_branch" >> "$GITHUB_OUTPUT"

      - name: Fetch base branch
        run: git fetch origin ${{ steps.default-branch.outputs.value }}

      - name: Detect components to deploy
        id: set
        env:
          COMPONENT_INPUT: ${{ github.event.inputs.component }}
        run: |
          set -euo pipefail
          component="${COMPONENT_INPUT:-auto}"
          backend=false
          frontend=false

          if [ "$component" != "auto" ]; then
            case "$component" in
              backend) backend=true ;;
              frontend) frontend=true ;;
              both) backend=true; frontend=true ;;
              *)
                echo "Invalid component selection: $component (expected auto/backend/frontend/both)"
                exit 1
                ;;
            esac
          else
            base="origin/${{ steps.default-branch.outputs.value }}"
            echo "Comparing changes against $base"
            changed=$(git diff --name-only "$base"...HEAD || true)
            echo "Changed files (relative to $base):"
            if [ -n "$changed" ]; then
              echo "$changed"
            else
              echo "(none)"
            fi

            if echo "$changed" | grep -E '^backend/' >/dev/null; then backend=true; fi
            if echo "$changed" | grep -E '^frontend/' >/dev/null; then frontend=true; fi
            if echo "$changed" | grep -E '^\\.github/workflows/' >/dev/null; then backend=true; frontend=true; fi

            if [ "$backend" = false ] && [ "$frontend" = false ]; then
              backend=true
              frontend=true
              echo "No component-specific changes detected; defaulting to deploy both."
            fi
          fi

          {
            echo "deploy_backend=$backend"
            echo "deploy_frontend=$frontend"
          } >> "$GITHUB_OUTPUT"

      - name: Summary
        run: |
          echo "Deploy backend: ${{ steps.set.outputs.deploy_backend }}"
          echo "Deploy frontend: ${{ steps.set.outputs.deploy_frontend }}"

  build-images:
    name: Build & Push Images
    runs-on: ubuntu-latest
    env:
      VITE_API_HOST: https://api.codehustle.com
    needs:
      - detect-scope
    permissions:
      contents: read
      packages: write
    outputs:
      backend_image: ${{ steps.meta.outputs.backend_image }}
      frontend_image: ${{ steps.meta.outputs.frontend_image }}
      image_tag: ${{ steps.gitmeta.outputs.tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref }}

      - name: Determine git metadata
        id: gitmeta
        run: |
          echo "tag=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"

      - name: Set image metadata
        id: meta
        run: |
          echo "backend_image=ghcr.io/${{ github.repository_owner }}/codehustle-backend" >> "$GITHUB_OUTPUT"
          echo "frontend_image=ghcr.io/${{ github.repository_owner }}/codehustle-frontend" >> "$GITHUB_OUTPUT"

      - name: Show deploy scope
        run: |
          echo "Deploy backend: ${{ needs.detect-scope.outputs.deploy_backend }}"
          echo "Deploy frontend: ${{ needs.detect-scope.outputs.deploy_frontend }}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1

      - name: Log in to GHCR
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build backend image
        if: needs.detect-scope.outputs.deploy_backend == 'true'
        run: |
          docker build -t "${{ steps.meta.outputs.backend_image }}:${{ steps.gitmeta.outputs.tag }}" -f backend/Dockerfile backend

      - name: Build frontend image
        if: needs.detect-scope.outputs.deploy_frontend == 'true'
        run: |
          docker build \
            --build-arg VITE_API_HOST="${VITE_API_HOST}" \
            -t "${{ steps.meta.outputs.frontend_image }}:${{ steps.gitmeta.outputs.tag }}" \
            frontend

      - name: Push backend image
        if: needs.detect-scope.outputs.deploy_backend == 'true'
        run: docker push "${{ steps.meta.outputs.backend_image }}:${{ steps.gitmeta.outputs.tag }}"

      - name: Push frontend image
        if: needs.detect-scope.outputs.deploy_frontend == 'true'
        run: docker push "${{ steps.meta.outputs.frontend_image }}:${{ steps.gitmeta.outputs.tag }}"

  deploy:
    name: Deploy (${{ matrix.target.name }})
    runs-on: ubuntu-latest
    needs:
      - decode-matrix
      - build-images
      - detect-scope
    if: ${{ needs.detect-scope.outputs.deploy_backend == 'true' || needs.detect-scope.outputs.deploy_frontend == 'true' }}
    strategy:
      fail-fast: false
      matrix:
        target: ${{ fromJSON(needs.decode-matrix.outputs.matrix != '' && needs.decode-matrix.outputs.matrix || '[{"name":"_none","skip":true}]') }}
    steps:
      - name: Debug needs structure
        run: |
          echo "=== needs (full object) ==="
          echo '${{ toJSON(needs) }}' | python3 -m json.tool || echo '${{ toJSON(needs) }}'
          echo ""
          echo "=== needs.decode-matrix (full object) ==="
          echo '${{ toJSON(needs.decode-matrix) }}' | python3 -m json.tool || echo '${{ toJSON(needs.decode-matrix) }}'
          echo ""
          echo "=== needs.decode-matrix.outputs (full object) ==="
          echo '${{ toJSON(needs.decode-matrix.outputs) }}' | python3 -m json.tool || echo '${{ toJSON(needs.decode-matrix.outputs) }}'
          echo ""
          echo "=== needs.decode-matrix.outputs.matrix (specific value) ==="
          echo "Value: '${{ needs.decode-matrix.outputs.matrix }}'"
          echo "Is empty: ${{ needs.decode-matrix.outputs.matrix == '' && 'YES' || 'NO' }}"
          echo "Is null: ${{ needs.decode-matrix.outputs.matrix == null && 'YES' || 'NO' }}"
      
      - name: Debug matrix output
        run: |
          echo "=== Raw matrix output from decode-matrix job ==="
          matrix_value='${{ needs.decode-matrix.outputs.matrix }}'
          echo "Matrix value: $matrix_value"
          echo "Matrix length: ${#matrix_value}"
          if [ -n "$matrix_value" ]; then
            echo "First char code: $(printf '%d' "'${matrix_value:0:1}")"
            echo "Last char code: $(printf '%d' "'${matrix_value: -1}")"
          else
            echo "WARNING: Matrix value is empty!"
          fi
          
          echo ""
          echo "=== Matrix strategy resolved values ==="
          echo "matrix.target.name: ${{ matrix.target.name }}"
          echo "matrix.target.host: ${{ matrix.target.host }}"
          echo "matrix.target.user: ${{ matrix.target.user }}"
          echo "matrix.target.path: ${{ matrix.target.path }}"
          echo "matrix.target.port: ${{ matrix.target.port }}"
          echo "matrix.target.skip: ${{ matrix.target.skip }}"
          
          echo ""
          echo "=== Testing JSON parsing ==="
          if [ -n "$matrix_value" ]; then
            if echo "$matrix_value" | python3 -m json.tool > /dev/null 2>&1; then
              echo "✓ JSON is valid"
              echo "Parsed JSON:"
              echo "$matrix_value" | python3 -m json.tool
            else
              echo "✗ JSON is invalid"
              echo "Trying to parse anyway..."
              echo "$matrix_value" | python3 -m json.tool || true
            fi
          fi
      
      - name: Skip deploy (no targets configured)
        if: ${{ matrix.target.skip == true }}
        run: |
          echo "No deployment targets configured (set DEPLOY_TARGETS secret). Skipping deploy."

      - name: Run remote deployment
        if: ${{ matrix.target.skip != true && (github.event.inputs.host == '' || github.event.inputs.host == matrix.target.name) }}
        uses: appleboy/ssh-action@029f5b4aeeeb58fdfe1410a5d17f967dacf36262 # v1.0.3
        with:
          host: ${{ matrix.target.host }}
          username: ${{ matrix.target.user }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ matrix.target.port || '22' }}
          passphrase: ${{ secrets.DEPLOY_SSH_KEY_PASSPHRASE }}
          script: |
            set -euo pipefail
            # Convert HTTPS URL to SSH format: https://github.com/owner/repo -> git@github.com:owner/repo.git
            REPO_HTTPS="${{ github.server_url }}/${{ github.repository }}"
            REPO=$(echo "$REPO_HTTPS" | sed 's|https://github.com/|git@github.com:|' | sed 's|$|.git|')
            REF="${{ github.event.inputs.ref }}"
            COMMIT="${{ needs.build-images.outputs.image_tag }}"
            WORKDIR="${{ matrix.target.path }}"

            if [ -z "$WORKDIR" ]; then
              echo "Deploy path for host '${{ matrix.target.name }}' is not configured."
              exit 1
            fi

            if [ ! -d "$WORKDIR/.git" ]; then
              echo "Cloning repository into $WORKDIR"
              rm -rf "$WORKDIR"
              git clone "$REPO" "$WORKDIR"
            fi

            cd "$WORKDIR"
            git fetch origin "$REF"
            git checkout "$COMMIT"
            git reset --hard "$COMMIT"

            cd backend

            if [ -n "${{ secrets.REGISTRY_USERNAME }}" ] && [ -n "${{ secrets.REGISTRY_PASSWORD }}" ]; then
              echo "Logging into container registry..."
              echo "${{ secrets.REGISTRY_PASSWORD }}" | docker login ghcr.io -u "${{ secrets.REGISTRY_USERNAME }}" --password-stdin
            fi

            chmod +x deploy.sh
            echo "Deploy backend: ${{ needs.detect-scope.outputs.deploy_backend }}"
            echo "Deploy frontend: ${{ needs.detect-scope.outputs.deploy_frontend }}"
            BACKEND_IMAGE_REPO="${{ needs.build-images.outputs.backend_image }}" \
            FRONTEND_IMAGE_REPO="${{ needs.build-images.outputs.frontend_image }}" \
            IMAGE_TAG="${{ needs.build-images.outputs.image_tag }}" \
            DEPLOY_BACKEND="${{ needs.detect-scope.outputs.deploy_backend }}" \
            DEPLOY_FRONTEND="${{ needs.detect-scope.outputs.deploy_frontend }}" \
            ./deploy.sh

  gce-targets:
    name: Prepare GCE Deploy Targets
    runs-on: ubuntu-latest
    outputs:
      matrix_b64: ${{ steps.collect.outputs.matrix_b64 }}
    steps:
      - id: collect
        run: |
          raw='${{ secrets.DEPLOY_TARGETS_GCE }}'
          if [ -z "$raw" ]; then
            raw='[{"name":"_none","skip":true}]'
          fi
          set +e
          matrix=$(python3 -c "import json,sys; data=json.loads(sys.stdin.read()); data=[data] if not isinstance(data, list) else data; print(json.dumps(data))" <<<"$raw" 2>&1)
          exit_code=$?
          set -e
          if [ $exit_code -ne 0 ]; then
            echo "Error parsing JSON: $matrix"
            matrix='[{"name":"_none","skip":true}]'
          fi
          matrix_b64=$(echo -n "$matrix" | base64 -w 0)
          echo "matrix_b64=$matrix_b64" >> "$GITHUB_OUTPUT"
          echo "Matrix encoded (length: ${#matrix_b64})"

  gce-decode-matrix:
    name: Decode GCE Matrix
    runs-on: ubuntu-latest
    needs: gce-targets
    outputs:
      matrix: ${{ steps.decode.outputs.matrix }}
    steps:
      - id: decode
        run: |
          matrix_b64='${{ needs.gce-targets.outputs.matrix_b64 }}'
          if [ -z "$matrix_b64" ]; then
            matrix='[{"name":"_none","skip":true}]'
          else
            matrix=$(echo -n "$matrix_b64" | base64 -d)
          fi
          delimiter="MATRIX_$(openssl rand -hex 16)"
          {
            echo "matrix<<${delimiter}"
            echo "$matrix"
            echo "${delimiter}"
          } >> "$GITHUB_OUTPUT"
          echo "Matrix decoded and written"

  deploy-gce:
    name: Deploy GCE (${{ matrix.target.name }})
    runs-on: ubuntu-latest
    needs:
      - gce-decode-matrix
      - build-images
      - detect-scope
    if: ${{ needs.detect-scope.outputs.deploy_backend == 'true' || needs.detect-scope.outputs.deploy_frontend == 'true' }}
    strategy:
      fail-fast: false
      matrix:
        target: ${{ fromJSON(needs.gce-decode-matrix.outputs.matrix != '' && needs.gce-decode-matrix.outputs.matrix || '[{"name":"_none","skip":true}]') }}
    steps:
      - name: Skip deploy (no targets configured)
        if: ${{ matrix.target.skip == true }}
        run: |
          echo "No GCE deployment targets configured (set DEPLOY_TARGETS_GCE secret). Skipping deploy."

      - name: Run remote deployment (GCE)
        if: ${{ matrix.target.skip != true && (github.event.inputs.host == '' || github.event.inputs.host == matrix.target.name) }}
        uses: appleboy/ssh-action@029f5b4aeeeb58fdfe1410a5d17f967dacf36262 # v1.0.3
        env:
          SSH_KEY_SECRET: ${{ matrix.target.key_secret || 'DEPLOY_SSH_KEY_GCE' }}
          SSH_PASSPHRASE_SECRET: ${{ matrix.target.passphrase_secret || 'DEPLOY_SSH_KEY_GCE_PASSPHRASE' }}
        with:
          host: ${{ matrix.target.host }}
          username: ${{ matrix.target.user }}
          key: ${{ secrets[env.SSH_KEY_SECRET] }}
          port: ${{ matrix.target.port || '22' }}
          passphrase: ${{ secrets[env.SSH_PASSPHRASE_SECRET] }}
          script: |
            set -euo pipefail
            REPO_HTTPS="${{ github.server_url }}/${{ github.repository }}"
            REPO=$(echo "$REPO_HTTPS" | sed 's|https://github.com/|git@github.com:|' | sed 's|$|.git|')
            REF="${{ github.event.inputs.ref }}"
            COMMIT="${{ needs.build-images.outputs.image_tag }}"
            WORKDIR="${{ matrix.target.path }}"
            DEPLOY_USER="${{ matrix.target.deploy_user || 'amiselfish2025' }}"

            if [ -z "$WORKDIR" ]; then
              echo "Deploy path for host '${{ matrix.target.name }}' is not configured."
              exit 1
            fi

            if ! command -v sudo >/dev/null 2>&1; then
              echo "sudo is required on the target host."
              exit 1
            fi

            sudo mkdir -p "$WORKDIR"
            sudo chown -R "$DEPLOY_USER":"$DEPLOY_USER" "$WORKDIR"

            if [ ! -d "$WORKDIR/.git" ]; then
              echo "Cloning repository into $WORKDIR"
              sudo rm -rf "$WORKDIR"
              sudo -u "$DEPLOY_USER" git clone "$REPO" "$WORKDIR"
            fi

            cd "$WORKDIR"
            sudo -u "$DEPLOY_USER" git fetch origin "$REF"
            sudo -u "$DEPLOY_USER" git checkout "$COMMIT"
            sudo -u "$DEPLOY_USER" git reset --hard "$COMMIT"

            cd backend

            if [ -n "${{ secrets.REGISTRY_USERNAME }}" ] && [ -n "${{ secrets.REGISTRY_PASSWORD }}" ]; then
              echo "Logging into container registry..."
              echo "${{ secrets.REGISTRY_PASSWORD }}" | docker login ghcr.io -u "${{ secrets.REGISTRY_USERNAME }}" --password-stdin
            fi

            sudo -u "$DEPLOY_USER" chmod +x deploy.sh
            echo "Deploy backend: ${{ needs.detect-scope.outputs.deploy_backend }}"
            echo "Deploy frontend: ${{ needs.detect-scope.outputs.deploy_frontend }}"
            sudo -u "$DEPLOY_USER" \
              BACKEND_IMAGE_REPO="${{ needs.build-images.outputs.backend_image }}" \
              FRONTEND_IMAGE_REPO="${{ needs.build-images.outputs.frontend_image }}" \
              IMAGE_TAG="${{ needs.build-images.outputs.image_tag }}" \
              DEPLOY_BACKEND="${{ needs.detect-scope.outputs.deploy_backend }}" \
              DEPLOY_FRONTEND="${{ needs.detect-scope.outputs.deploy_frontend }}" \
              ./deploy.sh

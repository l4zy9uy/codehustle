name: Manual Deploy

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref (branch or tag) to deploy"
        required: false
        default: master
      host:
        description: "Optional matrix host name (deploy all if empty)"
        required: false
        default: ""

jobs:
  targets:
    name: Prepare Deploy Targets
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.collect.outputs.matrix }}
    steps:
      - id: collect
        run: |
          MATRIX="${{ secrets.DEPLOY_TARGETS }}"
          if [ -z "$MATRIX" ]; then
            MATRIX='[]'
          fi
          echo "matrix=$MATRIX" >> "$GITHUB_OUTPUT"

  build-images:
    name: Build & Push Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      backend_image: ${{ steps.meta.outputs.backend_image }}
      frontend_image: ${{ steps.meta.outputs.frontend_image }}
      image_tag: ${{ steps.gitmeta.outputs.tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref }}

      - name: Determine git metadata
        id: gitmeta
        run: |
          echo "tag=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"

      - name: Set image metadata
        id: meta
        run: |
          echo "backend_image=ghcr.io/${{ github.repository_owner }}/codehustle-backend" >> "$GITHUB_OUTPUT"
          echo "frontend_image=ghcr.io/${{ github.repository_owner }}/codehustle-frontend" >> "$GITHUB_OUTPUT"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1

      - name: Log in to GHCR
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build backend image
        run: |
          docker build -t "${{ steps.meta.outputs.backend_image }}:${{ steps.gitmeta.outputs.tag }}" -f backend/Dockerfile backend

      - name: Build frontend image
        run: |
          docker build -t "${{ steps.meta.outputs.frontend_image }}:${{ steps.gitmeta.outputs.tag }}" frontend

      - name: Push backend image
        run: docker push "${{ steps.meta.outputs.backend_image }}:${{ steps.gitmeta.outputs.tag }}"

      - name: Push frontend image
        run: docker push "${{ steps.meta.outputs.frontend_image }}:${{ steps.gitmeta.outputs.tag }}"

  deploy:
    name: Deploy (${{ matrix.target.name }})
    runs-on: ubuntu-latest
    needs:
      - targets
      - build-images
    strategy:
      fail-fast: false
      matrix:
        target: ${{ fromJSON(needs.targets.outputs.matrix) }}
    steps:
      - name: Run remote deployment
        if: ${{ github.event.inputs.host == '' || github.event.inputs.host == matrix.target.name }}
        uses: appleboy/ssh-action@029f5b4aeeeb58fdfe1410a5d17f967dacf36262 # v1.0.3
        with:
          host: ${{ matrix.target.host }}
          username: ${{ matrix.target.user }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ matrix.target.port || '22' }}
          passphrase: ${{ secrets.DEPLOY_SSH_KEY_PASSPHRASE }}
          script: |
            set -euo pipefail
            REPO="${{ github.server_url }}/${{ github.repository }}"
            REF="${{ github.event.inputs.ref }}"
            COMMIT="${{ needs.build-images.outputs.image_tag }}"
            WORKDIR="${{ matrix.target.path }}"

            if [ -z "$WORKDIR" ]; then
              echo "Deploy path for host '${{ matrix.target.name }}' is not configured."
              exit 1
            fi

            if [ ! -d "$WORKDIR/.git" ]; then
              echo "Cloning repository into $WORKDIR"
              rm -rf "$WORKDIR"
              git clone "$REPO" "$WORKDIR"
            fi

            cd "$WORKDIR"
            git fetch origin "$REF"
            git checkout "$COMMIT"
            git reset --hard "$COMMIT"

            cd backend

            if [ -n "${{ secrets.REGISTRY_USERNAME }}" ] && [ -n "${{ secrets.REGISTRY_PASSWORD }}" ]; then
              echo "üîê Logging into container registry..."
              echo "${{ secrets.REGISTRY_PASSWORD }}" | docker login ghcr.io -u "${{ secrets.REGISTRY_USERNAME }}" --password-stdin
            fi

            chmod +x deploy.sh
            BACKEND_IMAGE_REPO="${{ needs.build-images.outputs.backend_image }}" \
            FRONTEND_IMAGE_REPO="${{ needs.build-images.outputs.frontend_image }}" \
            IMAGE_TAG="${{ needs.build-images.outputs.image_tag }}" \
            ./deploy.sh
